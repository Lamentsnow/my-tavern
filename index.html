<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é£˜é›ªé…’é¦† (Gemini Edition)</title>
    <!-- 1. å¼•å…¥ Tailwind CSS (å¿«é€Ÿå†™æ ·å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. å¼•å…¥ tsParticles (å·æ‡’å®ç°é£˜é›ª) -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-engine@2/tsparticles.engine.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2/tsparticles.slim.bundle.min.js"></script>
    <!-- 3. å¼•å…¥ Marked (Markdownæ¸²æŸ“) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #0f111a; color: #e2e8f0; font-family: sans-serif; }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .msg-user { background-color: #3b82f6; color: white; border-radius: 12px 12px 0 12px; }
        .msg-ai { background-color: #334155; color: #e2e8f0; border-radius: 12px 12px 12px 0; }
        
        /* Markdown æ ·å¼å¾®è°ƒ */
        .markdown-body pre { background: #0f111a; padding: 10px; border-radius: 6px; overflow-x: auto; }
        .markdown-body code { font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative">

    <!-- ç²’å­èƒŒæ™¯å®¹å™¨ -->
    <div id="tsparticles" class="absolute inset-0 z-0"></div>

    <!-- ä¸»ç•Œé¢å®¹å™¨ -->
    <div class="relative z-10 container mx-auto h-full max-w-4xl p-4 flex flex-col">
        
        <!-- é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + è®¾ç½® -->
        <header class="glass-panel p-4 rounded-xl flex flex-wrap justify-between items-center mb-4 gap-2">
            <div class="flex items-center gap-2">
                <span class="text-2xl">â„ï¸</span>
                <h1 class="text-xl font-bold tracking-wider">AI Tavern</h1>
            </div>
            
            <div class="flex gap-2 items-center">
                <!-- API Key è¾“å…¥ -->
                <input type="password" id="apiKeyInput" placeholder="åœ¨æ­¤ç²˜è´´ Gemini API Key" 
                    class="bg-slate-800 border border-slate-600 rounded px-3 py-1 text-sm w-48 focus:outline-none focus:border-blue-500 transition">
                
                <!-- å­˜æ¡£/è¯»æ¡£æŒ‰é’® -->
                <button onclick="exportHistory()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm transition" title="ä¿å­˜å¯¹è¯åˆ°æœ¬åœ°">ğŸ’¾ ä¿å­˜</button>
                <button onclick="document.getElementById('fileInput').click()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm transition" title="ä»æœ¬åœ°åŠ è½½å¯¹è¯">ğŸ“‚ è¯»å–</button>
                <button onclick="clearHistory()" class="bg-red-900/50 hover:bg-red-800/50 text-red-200 px-3 py-1 rounded text-sm transition" title="æ¸…ç©ºå†å²">ğŸ—‘ï¸</button>
                
                <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="importHistory(this)">
            </div>
        </header>

        <!-- å¯¹è¯åŒºåŸŸ -->
        <main id="chatContainer" class="glass-panel flex-1 rounded-xl p-4 overflow-y-auto flex flex-col gap-4 mb-4">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="flex justify-start">
                <div class="msg-ai px-4 py-3 max-w-[85%] shadow-lg">
                    <p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ã€‚è¯·åœ¨å³ä¸Šæ–¹å¡«å…¥ API Key å¼€å§‹å¯¹è¯ã€‚</p>
                    <p class="text-xs text-slate-400 mt-2">æ”¯æŒ Markdown | è‡ªåŠ¨ä¿å­˜ | æœ¬åœ°è¯»å†™</p>
                </div>
            </div>
        </main>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <footer class="glass-panel p-4 rounded-xl">
            <div class="flex gap-2">
                <textarea id="userInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)" 
                    class="flex-1 bg-slate-800 border-none outline-none text-white px-4 py-3 rounded-lg resize-none overflow-hidden"
                    oninput="autoResize(this)"
                    onkeydown="handleEnter(event)"></textarea>
                <button id="sendBtn" onclick="sendMessage()" 
                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-lg font-medium transition flex items-center justify-center">
                    å‘é€
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- 1. tsParticles é…ç½® (å·æ‡’éƒ¨åˆ†ï¼šç›´æ¥ç”¨é…ç½®å®ç°é£˜é›ª) ---
        (async () => {
            await loadSlim(tsParticles);
            await tsParticles.load("tsparticles", {
                particles: {
                    number: { value: 100, density: { enable: true, area: 800 } },
                    color: { value: "#ffffff" },
                    shape: { type: "circle" },
                    opacity: { value: 0.5, random: true },
                    size: { value: 2, random: true },
                    move: {
                        enable: true,
                        speed: 1, // é£˜è½é€Ÿåº¦
                        direction: "bottom", // å‘ä¸‹é£˜
                        random: true,
                        straight: false,
                        outModes: { default: "out" }, // ç§»å‡ºå±å¹•åé‡ç½®
                    }
                },
                interactivity: {
                    events: { onHover: { enable: true, mode: "repulse" } }, // é¼ æ ‡æ‚¬åœæ’æ–¥æ•ˆæœ
                    modes: { repulse: { distance: 100, duration: 0.4 } }
                }
            });
        })();

        // --- 2. æ ¸å¿ƒé€»è¾‘ ---
        
        let chatHistory = []; // ä¿å­˜ä¸Šä¸‹æ–‡
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const apiKeyInput = document.getElementById('apiKeyInput');

        // åˆå§‹åŒ–ï¼šåŠ è½½æœ¬åœ°ç¼“å­˜
        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) apiKeyInput.value = savedKey;

            const savedHistory = localStorage.getItem('chat_history');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                renderHistory();
            }
        };

        // ç›‘å¬ API Key å˜åŒ–å¹¶ä¿å­˜
        apiKeyInput.addEventListener('change', (e) => {
            localStorage.setItem('gemini_api_key', e.target.value);
        });

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // å¤„ç†å›è½¦å‘é€
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // æ¸²æŸ“å•æ¡æ¶ˆæ¯
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `${role === 'user' ? 'msg-user' : 'msg-ai'} px-4 py-3 max-w-[85%] shadow-lg markdown-body`;
            
            // ä½¿ç”¨ marked è§£æ markdown
            bubble.innerHTML = role === 'user' ? text.replace(/\n/g, '<br>') : marked.parse(text);
            
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // é‡æ–°æ¸²æŸ“æ‰€æœ‰å†å²
        function renderHistory() {
            chatContainer.innerHTML = ''; // æ¸…ç©º
            // ä¿ç•™é‚£æ¡æ¬¢è¿è¯­æˆ–è€…ä¹Ÿå¯ä»¥ä¸ä¿ç•™ï¼Œè¿™é‡Œé€‰æ‹©åªæ¸²æŸ“å†å²
            if(chatHistory.length === 0) {
                 const welcome = `<div class="flex justify-start"><div class="msg-ai px-4 py-3 max-w-[85%] shadow-lg"><p>å¯¹è¯è®°å½•å·²æ¸…ç©ºæˆ–åŠ è½½ã€‚è¯·å¼€å§‹æ–°çš„å¯¹è¯ã€‚</p></div></div>`;
                 chatContainer.innerHTML = welcome;
                 return;
            }
            chatHistory.forEach(msg => {
                appendMessage(msg.role, msg.parts[0].text);
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const text = userInput.value.trim();
            const key = apiKeyInput.value.trim();

            if (!text) return;
            if (!key) { alert('è¯·å…ˆè¾“å…¥ Google Gemini API Key'); return; }

            // 1. UI æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            userInput.value = '';
            userInput.style.height = 'auto';
            appendMessage('user', text);

            // 2. æ›´æ–°å†å²æ•°æ® (Gemini æ ¼å¼)
            const newMsg = { role: 'user', parts: [{ text: text }] };
            chatHistory.push(newMsg);

            // 3. æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex justify-start loading-indicator';
            loadingDiv.innerHTML = `<div class="msg-ai px-4 py-2 text-sm italic opacity-70">Thinking... â„ï¸</div>`;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // 4. è°ƒç”¨ API (Google Gemini)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory })
                });

                const data = await response.json();
                
                // ç§»é™¤ loading
                chatContainer.removeChild(loadingDiv);

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiText = data.candidates[0].content.parts[0].text;

                // 5. UI æ˜¾ç¤º AI æ¶ˆæ¯
                appendMessage('model', aiText);
                
                // 6. ä¿å­˜å†å²
                chatHistory.push({ role: 'model', parts: [{ text: aiText }] });
                localStorage.setItem('chat_history', JSON.stringify(chatHistory));

            } catch (error) {
                if(document.querySelector('.loading-indicator')) chatContainer.removeChild(loadingDiv);
                appendMessage('model', `**Error:** ${error.message}`);
            }
        }

        // --- 3. å­˜æ¡£/è¯»æ¡£åŠŸèƒ½ ---

        // å¯¼å‡ºå†å² (JSON)
        function exportHistory() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(chatHistory));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "chat_history_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // å¯¼å…¥å†å²
        function importHistory(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        chatHistory = json;
                        localStorage.setItem('chat_history', JSON.stringify(chatHistory));
                        renderHistory();
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (err) {
                    alert('æ— æ³•è§£æ JSON æ–‡ä»¶');
                }
            };
            reader.readAsText(file);
            // é‡ç½® input ä»¥ä¾¿ä¸‹æ¬¡èƒ½é‡å¤é€‰åŒä¸€ä¸ªæ–‡ä»¶
            input.value = '';
        }

        // æ¸…ç©ºå†å²
        function clearHistory() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                chatHistory = [];
                localStorage.removeItem('chat_history');
                renderHistory();
            }
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek é›ªå¤œé…’é¦†</title>
    <!-- 1. æ ·å¼åº“ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. ç²’å­åº“ tsParticles -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-engine@2/tsparticles.engine.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2/tsparticles.slim.bundle.min.js"></script>
    <!-- 3. Markdown è§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 4. å®‰å…¨è¿‡æ»¤åº“ DOMPurify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <style>
        body { background-color: #0f111a; color: #e2e8f0; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .msg-user { background-color: #4f46e5; color: white; border-radius: 12px 12px 0 12px; }
        .msg-ai { background-color: #334155; color: #e2e8f0; border-radius: 12px 12px 12px 0; }
        
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body pre { background: #1e1e1e; padding: 10px; border-radius: 6px; overflow-x: auto; margin-top: 8px; }
        .markdown-body code { font-family: Consolas, Monaco, monospace; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; font-size: 0.9em; }
        .markdown-body ul { list-style-type: disc; padding-left: 20px; }
        .markdown-body ol { list-style-type: decimal; padding-left: 20px; }
        .markdown-body a { color: #60a5fa; text-decoration: underline; }
        .markdown-body blockquote { border-left: 4px solid #64748b; padding-left: 10px; color: #94a3b8; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative selection:bg-indigo-500 selection:text-white">

    <div id="tsparticles" class="absolute inset-0 z-0 pointer-events-none"></div>

    <div class="relative z-10 container mx-auto h-full max-w-4xl p-4 flex flex-col">
        <header class="glass-panel p-4 rounded-xl flex flex-wrap justify-between items-center mb-4 gap-3">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-lg">â„ï¸</div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide">DeepSeek Tavern</h1>
                    <div class="text-xs text-slate-400">Powered by SiliconFlow</div>
                </div>
            </div>
            
            <div class="flex gap-2 items-center flex-wrap">
                <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ SiliconFlow API Key" autocomplete="off"
                    class="bg-slate-800/80 border border-slate-600 rounded px-3 py-1.5 text-sm w-52 focus:outline-none focus:border-indigo-500 transition text-slate-200 placeholder-slate-500">
                
                <div class="flex gap-1">
                    <button onclick="exportHistory()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm transition" title="ä¿å­˜å¯¹è¯">ğŸ’¾</button>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm transition" title="è¯»å–å¯¹è¯">ğŸ“‚</button>
                    <button onclick="clearHistory()" class="bg-red-900/40 hover:bg-red-800/60 text-red-200 px-3 py-1.5 rounded text-sm transition" title="æ¸…ç©º">ğŸ—‘ï¸</button>
                </div>
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="importHistory(this)">
            </div>
        </header>

        <main id="chatContainer" class="glass-panel flex-1 rounded-xl p-4 overflow-y-auto flex flex-col gap-6 mb-4 scroll-smooth">
            <div class="flex justify-start opacity-80">
                <div class="msg-ai px-5 py-3 max-w-[85%] shadow-lg text-sm">
                    <p>ä½ å¥½ï¼æˆ‘æ˜¯ DeepSeek-V3ã€‚</p>
                    <p class="mt-1">å¦‚æœé‡åˆ°è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥å³ä¸Šè§’çš„ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æŒ‰ F12 æŸ¥çœ‹æ§åˆ¶å°æŠ¥é”™ã€‚</p>
                </div>
            </div>
        </main>

        <footer class="glass-panel p-3 rounded-xl">
            <div class="flex gap-3 items-end">
                <textarea id="userInput" rows="1" placeholder="å‘é€æ¶ˆæ¯ç»™ DeepSeek... (Shift+Enter æ¢è¡Œ)" 
                    class="flex-1 bg-slate-800/50 border border-transparent focus:border-indigo-500/50 outline-none text-white px-4 py-3 rounded-lg resize-none overflow-hidden transition-colors"
                    oninput="autoResize(this)"
                    onkeydown="handleEnter(event)"></textarea>
                <button id="sendBtn" onclick="sendMessage()" 
                    class="bg-indigo-600 hover:bg-indigo-500 text-white h-[46px] px-6 rounded-lg font-medium transition shadow-lg shadow-indigo-500/20 whitespace-nowrap">
                    å‘é€
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- 1. ç²’å­èƒŒæ™¯ ---
        (async () => {
            await loadSlim(tsParticles);
            await tsParticles.load("tsparticles", {
                fpsLimit: 60,
                particles: {
                    number: { value: 60, density: { enable: true, area: 800 } },
                    color: { value: "#cbd5e1" },
                    shape: { type: "circle" },
                    opacity: { value: 0.6, random: true },
                    size: { value: 2, random: true },
                    move: { enable: true, speed: 0.5, direction: "bottom", random: false, straight: false, outModes: "out" }
                },
                detectRetina: true,
            });
        })();

        // --- 2. æ ¸å¿ƒé€»è¾‘ ---
        
        let chatHistory = []; 
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const LOCAL_STORAGE_KEY_API = 'siliconflow_api_key_v3'; 
        const LOCAL_STORAGE_KEY_CHAT = 'deepseek_chat_history_v3';

        window.onload = () => {
            marked.use({ gfm: true, breaks: true });
            const savedKey = localStorage.getItem(LOCAL_STORAGE_KEY_API);
            if (savedKey) apiKeyInput.value = savedKey;

            const savedHistory = localStorage.getItem(LOCAL_STORAGE_KEY_CHAT);
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                    renderHistory();
                } catch(e) { console.error("History parse error", e); }
            }
        };

        apiKeyInput.addEventListener('change', (e) => {
            localStorage.setItem(LOCAL_STORAGE_KEY_API, e.target.value.trim());
        });

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 150) + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bubble = document.createElement('div');
            bubble.className = `${role === 'user' ? 'msg-user' : 'msg-ai'} px-5 py-3 max-w-[85%] shadow-md markdown-body text-[15px] leading-relaxed`;
            
            let rawHtml = '';
            if (role === 'user') {
                rawHtml = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>'); 
            } else {
                // ä¿®å¤æ³¢æµªå·è¢«å½“ä½œåˆ é™¤çº¿çš„é—®é¢˜
                const safeContent = content.replace(/~/g, '\\~');
                rawHtml = marked.parse(safeContent);
            }

            const cleanHtml = DOMPurify.sanitize(rawHtml, { ADD_ATTR: ['target'] });
            bubble.innerHTML = cleanHtml;
            
            if (role !== 'user') {
                const links = bubble.querySelectorAll('a');
                links.forEach(link => link.target = '_blank');
            }

            div.appendChild(bubble);
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderHistory() {
            chatContainer.innerHTML = '';
            if (chatHistory.length === 0) {
                 const welcome = document.createElement('div');
                 welcome.className = "flex justify-start opacity-80";
                 welcome.innerHTML = `<div class="msg-ai px-5 py-3 max-w-[85%] shadow-lg text-sm"><p>å†å²è®°å½•å·²æ¸…ç©ºã€‚</p></div>`;
                 chatContainer.appendChild(welcome);
                 return;
            }
            chatHistory.forEach(msg => {
                appendMessage(msg.role, msg.content);
            });
        }

        // --- ä¿®å¤åçš„å‘é€é€»è¾‘ ---
        async function sendMessage() {
            const text = userInput.value.trim();
            const key = apiKeyInput.value.trim();

            if (!text) return;
            if (!key) { alert('è¯·å…ˆåœ¨é¡¶éƒ¨å¡«å…¥ SiliconFlow API Key'); return; }

            userInput.value = '';
            userInput.style.height = 'auto';
            appendMessage('user', text);
            chatHistory.push({ role: 'user', content: text });

            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `<div class="msg-ai px-5 py-3 opacity-70 flex items-center gap-2"><span class="animate-pulse">Thinking</span>...</div>`;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "deepseek-ai/DeepSeek-V3",
                        messages: chatHistory,
                        stream: false, 
                        temperature: 0.7,
                        max_tokens: 4096 
                    })
                });

                // 1. å…ˆå°è¯•è·å–æ–‡æœ¬ï¼Œä»¥é˜² JSON è§£æå¤±è´¥
                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                    console.log("API Response:", data); // åœ¨æ§åˆ¶å°æ‰“å°ï¼Œæ–¹ä¾¿è°ƒè¯•
                } catch (e) {
                    throw new Error(`API è¿”å›äº†é JSON æ•°æ®: ${responseText.substring(0, 50)}...`);
                }

                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();

                // 2. æ£€æŸ¥ HTTP çŠ¶æ€ç 
                if (!response.ok) {
                    // å°è¯•æå– SiliconFlow çš„å…·ä½“é”™è¯¯ä¿¡æ¯
                    const errorMsg = data.error?.message || data.message || `HTTP Error ${response.status}`;
                    throw new Error(errorMsg);
                }

                // 3. æ£€æŸ¥æ•°æ®ç»“æ„
                if (!data.choices || data.choices.length === 0) {
                    // å¦‚æœæˆåŠŸäº†ä½†æ²¡æœ‰ choicesï¼Œå¯èƒ½æ˜¯ç‰¹å®šä¸šåŠ¡é”™è¯¯
                    if (data.message) throw new Error(data.message);
                    throw new Error("API è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼šæ‰¾ä¸åˆ° choices å­—æ®µ");
                }

                const aiText = data.choices[0].message.content;
                appendMessage('assistant', aiText);
                chatHistory.push({ role: 'assistant', content: aiText });
                localStorage.setItem(LOCAL_STORAGE_KEY_CHAT, JSON.stringify(chatHistory));

            } catch (error) {
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
                console.error(error); // æ‰“å°å®Œæ•´é”™è¯¯åˆ°æ§åˆ¶å°
                appendMessage('assistant', `âš ï¸ **è¯·æ±‚å‡ºé”™:** ${error.message}\n\n*è¯·æŒ‰ F12 æŸ¥çœ‹ Console è·å–è¯¦ç»†ä¿¡æ¯*`);
            }
        }

        // --- 3. è¾…åŠ©åŠŸèƒ½ ---
        function exportHistory() {
            if(chatHistory.length === 0) { alert("æ²¡æœ‰å†å²è®°å½•"); return; }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(chatHistory, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `deepseek_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(dl); dl.click(); dl.remove();
        }

        function importHistory(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        chatHistory = json;
                        localStorage.setItem(LOCAL_STORAGE_KEY_CHAT, JSON.stringify(chatHistory));
                        renderHistory();
                    }
                } catch (err) { alert('JSON è§£æå¤±è´¥'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function clearHistory() {
            if(confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) {
                chatHistory = [];
                localStorage.removeItem(LOCAL_STORAGE_KEY_CHAT);
                renderHistory();
            }
        }
    </script>
</body>
</html>
